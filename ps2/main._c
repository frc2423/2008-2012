/*
	Lab 3, Task 3
	5/17/2006
	Dustin Spicuzza

	Software delay loop
*/

#include <mc9s12dp256.h>

void delay450ms(void);

void main(){

	DDRA = 0xff;		// set port a to output
	PORTA = 0x00;		// initial output

	while(1){
		delay450ms();				// delay
		PORTA += 1;					// i'm not sure how this is defined, but make 
									// sure it treats it as a unsigned!
		delay450ms();
		((unsigned char)PORTA)++;
	}

}


/*
	Time Delay function, purely in assembly (including the function declaration)

		450ms/41.67ns = ~10799 cycles to delay

		4 + (outer (inner) ) + 5 = 10799
		4 + (((2 + ((x - 1) 3 + 2) + 1) - 1) * y) +2 + 5 = 10799
		3xy + y + 11 = 10799
		3xy + y = 10788 --> X = 599, Y = 6
	
*/


// bsr:  4 cycles (intro to loop)
asm("_delay450ms:		");
asm("	ldx #$6			");		// 2 cycles (Y variable)
asm("l_out:				");	
asm("	ldy #$257		");		// 2 cycles (X variable)
asm("l_in:				");
asm("	dbne y, l_in	");		// 3 (not taken) /1 (taken) cycles
asm("	dbne x, l_out	");		// 3 (not taken) /1 (taken) cycles
asm("	rts				");		// 5 cycles

/*

	This code borrowed from the uC/OS-II source code, sets the PLL to 24Mhz. _HC12Setup is a function
	called by ICC12 as a part of its setup routine, before user code is called. 

*/
void _HC12Setup(void) {
   
	// Generate 24 MHz system clock.
	SYNR = 2;
	REFDV = 1;
	while((CRGFLG & 0x08) == 0x00) {}	// Wait for PLL lock-in.
	CLKSEL = CLKSEL | 0x80;				// Select PLL Clock as System Clock.
}